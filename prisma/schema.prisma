// Prisma Schema - 일산마리아병원 재진 예약 시스템
// 자세한 정보: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 의사 (Doctor)
// ============================================
model Doctor {
  id           String   @id @default(cuid())
  name         String
  department   String
  position     String?
  bio          String?
  imageUrl     String?
  isActive     Boolean  @default(true)
  sortOrder    Int      @default(0)
  
  // 로그인 정보 (선택)
  email        String?  @unique
  passwordHash String?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  scheduleTemplates  ScheduleTemplate[]
  scheduleExceptions ScheduleException[]
  appointments       Appointment[]

  @@map("doctors")
}

// ============================================
// 스케줄 템플릿 (요일별 기본)
// ============================================
model ScheduleTemplate {
  id                   String  @id @default(cuid())
  doctorId             String
  dayOfWeek            Int
  startTime            String
  endTime              String
  slotIntervalMinutes  Int     @default(15)
  dailyMaxAppointments Int?
  isActive             Boolean @default(true)

  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, dayOfWeek, startTime])
  @@index([doctorId, dayOfWeek, isActive])  // 슬롯 조회 최적화
  @@map("schedule_templates")
}

// ============================================
// 스케줄 예외 (특별 스케줄 / 휴진)
// ============================================
model ScheduleException {
  id             String  @id @default(cuid())
  doctorId       String
  date           String
  type           String
  customStart    String?
  customEnd      String?
  customInterval Int?
  reason         String?

  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, date])
  @@index([date])  // 날짜별 일괄 조회 최적화
  @@map("schedule_exceptions")
}

// ============================================
// 환자 (Patient)
// ============================================
model Patient {
  id           String   @id @default(cuid())
  name         String
  birthDate    String?
  phone        String?

  kakaoId      String?  @unique
  kakaoEmail   String?
  kakaoProfile String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointments Appointment[]

  @@unique([name, birthDate, phone])
  @@index([phone])      // 전화번호 검색 최적화
  @@index([name])       // 이름 검색 최적화
  @@map("patients")
}

// ============================================
// 예약 (Appointment)
// ============================================
model Appointment {
  id         String   @id @default(cuid())
  doctorId   String
  patientId  String
  date       String
  time       String
  status     String   @default("BOOKED")
  memo       String?
  reservedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // EMR 등록 관리
  emrSynced    Boolean   @default(false)  // EMR에 등록 완료 여부
  emrSyncedAt  DateTime?                  // EMR 등록 시간
  emrSyncedBy  String?                    // EMR 등록한 관리자 ID

  doctor  Doctor  @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // 복합 인덱스 (쿼리 패턴에 최적화)
  @@index([doctorId, date, status])      // 슬롯 조회: WHERE doctorId AND date AND status IN
  @@index([doctorId, date, time])        // 중복 체크: WHERE doctorId AND date AND time
  @@index([patientId, date, status])     // 환자별 예약 조회
  @@index([date, status])                // 날짜별 통계
  @@index([reservedAt])                  // 최근 예약 정렬
  @@index([emrSynced, date])             // EMR 미등록 예약 조회
  @@map("appointments")
}

// ============================================
// 관리자 (AdminUser)
// ============================================
model AdminUser {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         String   @default("STAFF")
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  notifications AdminNotification[]

  @@map("admin_users")
}

// ============================================
// 관리자 알림 (AdminNotification)
// ============================================
model AdminNotification {
  id            String   @id @default(cuid())
  type          String   // NEW_APPOINTMENT, CANCELLED, STATUS_CHANGED 등
  title         String
  message       String
  appointmentId String?
  isRead        Boolean  @default(false)
  createdAt     DateTime @default(now())

  // 특정 관리자에게만 보이는 알림 (null이면 전체)
  adminId       String?
  admin         AdminUser? @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([isRead, createdAt])
  @@map("admin_notifications")
}

// ============================================
// 예약 변경 요청 (ScheduleChangeRequest)
// ============================================
model ScheduleChangeRequest {
  id              String   @id @default(cuid())
  doctorId        String   // 요청한 의사
  appointmentId   String?  // 변경할 예약 (취소 요청인 경우)
  
  requestType     String   // RESCHEDULE(일정변경), CANCEL(취소), OFF_DAY(휴진)
  
  // 일정 변경 관련
  originalDate    String?  // 기존 날짜
  originalTime    String?  // 기존 시간
  newDate         String?  // 변경 요청 날짜
  newTime         String?  // 변경 요청 시간
  
  // 휴진 요청 관련
  offDate         String?  // 휴진 날짜
  offReason       String?  // 휴진 사유
  
  reason          String?  // 변경/취소 사유
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED
  
  // 관리자 처리 관련
  processedBy     String?  // 처리한 관리자 ID
  processedAt     DateTime?
  rejectReason    String?  // 거절 사유
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([doctorId, status])
  @@index([status, createdAt])
  @@map("schedule_change_requests")
}

// ============================================
// 알림 로그 (NotificationLog)
// ============================================
model NotificationLog {
  id            String   @id @default(cuid())
  type          String   // CONFIRM, CANCEL, REMINDER_1DAY, REMINDER_TODAY, STATUS_CHANGE, RESCHEDULE
  channel       String   // ALIMTALK, SMS, PUSH
  recipientPhone String
  recipientName String
  appointmentId String?
  
  // 발송 내용
  templateCode  String?
  message       String   @db.Text
  
  // 발송 결과
  status        String   @default("PENDING") // PENDING, SENT, FAILED
  errorMessage  String?
  sentAt        DateTime?
  
  createdAt     DateTime @default(now())

  @@index([appointmentId])
  @@index([status, createdAt])
  @@index([type, createdAt])
  @@map("notification_logs")
}

// ============================================
// 알림 설정 (NotificationSetting)
// ============================================
model NotificationSetting {
  id            String   @id @default(cuid())
  key           String   @unique
  value         String
  description   String?
  updatedAt     DateTime @updatedAt

  @@map("notification_settings")
}

// ============================================
// 사전 계산된 슬롯 (DailySlotSummary)
// 매일 자정에 향후 4주치 슬롯을 미리 계산하여 저장
// 조회 시 복잡한 계산 없이 즉시 반환
// ============================================
model DailySlotSummary {
  id              String   @id @default(cuid())
  doctorId        String
  date            String   // YYYY-MM-DD
  totalSlots      Int      @default(0)
  availableSlots  Int      @default(0)
  bookedSlots     Int      @default(0)
  isOff           Boolean  @default(false)  // 휴진일
  updatedAt       DateTime @updatedAt

  @@unique([doctorId, date])
  @@index([date])
  @@index([doctorId, date, availableSlots])
  @@map("daily_slot_summaries")
}
