// Prisma Schema - 일산마리아병원 재진 예약 시스템
// 자세한 정보: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// 의사 (Doctor)
// ============================================
model Doctor {
  id         String   @id @default(cuid())
  name       String
  department String   // 진료과 (예: 산부인과, 마취통증의학과 등)
  position   String?  // 직책 (원장, 부장, 과장 등)
  bio        String?  // 약력 (줄바꿈으로 구분)
  imageUrl   String?  // 프로필 이미지 URL
  isActive   Boolean  @default(true)
  sortOrder  Int      @default(0) // 정렬 순서
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  scheduleTemplates  ScheduleTemplate[]
  scheduleExceptions ScheduleException[]
  appointments       Appointment[]

  @@map("doctors")
}

// ============================================
// 스케줄 템플릿 (ScheduleTemplate)
// - 의사의 요일별 기본 진료 시간 설정
// ============================================
model ScheduleTemplate {
  id                   String  @id @default(cuid())
  doctorId             String
  dayOfWeek            Int     // 0(일) ~ 6(토)
  startTime            String  // "09:00"
  endTime              String  // "12:00"
  slotIntervalMinutes  Int     @default(15) // 예약 간격 (분)
  dailyMaxAppointments Int?    // 하루 최대 예약 수 (null = 제한 없음)
  isActive             Boolean @default(true)

  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, dayOfWeek, startTime])
  @@map("schedule_templates")
}

// ============================================
// 스케줄 예외 (ScheduleException)
// - 휴진 또는 특별 스케줄
// ============================================
model ScheduleException {
  id             String  @id @default(cuid())
  doctorId       String
  date           String  // "2024-01-15" (YYYY-MM-DD)
  type           String  // "OFF" (휴진) | "CUSTOM" (특별 스케줄)
  customStart    String? // CUSTOM일 때만: "10:00"
  customEnd      String? // CUSTOM일 때만: "11:30"
  customInterval Int?    // CUSTOM일 때만: 분 단위
  reason         String? // 휴진 사유 (학회, 휴가 등)

  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, date])
  @@map("schedule_exceptions")
}

// ============================================
// 환자 (Patient)
// - 카카오 로그인 또는 이름+생년월일+전화번호로 식별
// ============================================
model Patient {
  id        String   @id @default(cuid())
  name      String
  birthDate String?  // "19900101" (YYYYMMDD) - 카카오 로그인 시 null 가능
  phone     String?  // "01012345678" - 카카오 로그인 시 null 가능
  
  // 카카오 로그인 연동
  kakaoId       String?  @unique // 카카오 고유 ID
  kakaoEmail    String?  // 카카오 이메일
  kakaoProfile  String?  // 카카오 프로필 이미지 URL
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointments Appointment[]

  @@unique([name, birthDate, phone])
  @@map("patients")
}

// ============================================
// 예약 (Appointment)
// ============================================
model Appointment {
  id         String   @id @default(cuid())
  doctorId   String
  patientId  String
  date       String   // "2024-01-15" (YYYY-MM-DD)
  time       String   // "09:00" (HH:MM)
  status     String   @default("BOOKED") // BOOKED | COMPLETED | NO_SHOW | CANCELLED
  memo       String?  // 직원용 메모
  reservedAt DateTime @default(now()) // 예약 생성 시각
  updatedAt  DateTime @updatedAt

  doctor  Doctor  @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([doctorId, date])
  @@index([patientId])
  @@index([date, status])
  @@map("appointments")
}

// ============================================
// 관리자/직원 계정 (AdminUser)
// ============================================
model AdminUser {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         String   @default("STAFF") // ADMIN | STAFF
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("admin_users")
}
